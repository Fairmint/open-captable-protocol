# Use the official Node.js 18 image
FROM node:18

# Set the working directory
WORKDIR /app

# Environment setup to avoid esbuild platform bloat
ENV npm_config_platform=linux
ENV npm_config_arch=x64
ENV ESBUILD_BINARY_PATH=node_modules/esbuild/bin/esbuild
ENV NODE_ENV=development

# Copy package files early to leverage Docker cache
COPY package.json yarn.lock ./

# Install dependencies with verbosity and concurrency limits
RUN yarn install --frozen-lockfile --network-concurrency 5 --no-progress --verbose

# Copy the full app source
COPY . .

# Expose dev server port
EXPOSE 8080

# Start in dev mode, but run the app directly without a file watcher
CMD ["sh", "-c", "NODE_ENV=development USE_ENV_FILE=.env.dev npx tsx src/app.js"]
