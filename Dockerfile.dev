# Use the official Node.js 18 image
FROM node:18

# Set the working directory
WORKDIR /app

# Environment setup to avoid esbuild platform bloat
ENV npm_config_platform=linux
ENV npm_config_arch=x64
ENV ESBUILD_BINARY_PATH=node_modules/esbuild/bin/esbuild
ENV NODE_ENV=development

# Copy package files early to leverage Docker cache
COPY package.json yarn.lock ./

# Install dependencies with verbosity and concurrency limits
RUN yarn install --frozen-lockfile --network-concurrency 5 --no-progress

# Copy the full app source
COPY . .

# Build the application
RUN npx esbuild src/app.js --bundle --platform=node --format=esm --outfile=dist/app.js

# Expose dev server port
EXPOSE 8080

# Start in dev mode, running the built file with node
ENTRYPOINT ["sh", "-c", "NODE_ENV=development USE_ENV_FILE=.env.dev node dist/app.js"]
